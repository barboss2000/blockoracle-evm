<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BTC Prediction â€” Robinhood Chain</title>

<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@700;800&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://s3.tradingview.com/tv.js"></script>

<style>
:root {
  --neon: #d5fd51;
  --neon-dim: rgba(213,253,81,0.12);
  --neon-dim2: rgba(213,253,81,0.06);
  --black: #0a0a0a;
  --surface: #111111;
  --surface2: #181818;
  --surface3: #202020;
  --border: #2a2a2a;
  --border-light: #333333;
  --text: #ffffff;
  --text-muted: #666666;
  --text-dim: #444444;
  --up: #4ade80;
  --down: #f87171;
  --up-dim: rgba(74,222,128,0.1);
  --down-dim: rgba(248,113,113,0.1);
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: var(--black);
  color: var(--text);
  font-family: 'DM Mono', monospace;
  min-height: 100vh;
}

/* Subtle grid background */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(rgba(213,253,81,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(213,253,81,0.03) 1px, transparent 1px);
  background-size: 40px 40px;
  pointer-events: none;
  z-index: 0;
}

.page { position: relative; z-index: 1; }

/* Header */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 32px;
  border-bottom: 1px solid var(--border);
  background: rgba(10,10,10,0.95);
  backdrop-filter: blur(10px);
  position: sticky;
  top: 0;
  z-index: 100;
}

.logo {
  display: flex;
  align-items: center;
  gap: 10px;
}

.logo-icon {
  width: 28px;
  height: 28px;
  background: var(--neon);
  clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
  display: flex;
  align-items: center;
  justify-content: center;
  animation: pulse-logo 3s ease-in-out infinite;
}

@keyframes pulse-logo {
  0%, 100% { box-shadow: 0 0 0 0 rgba(213,253,81,0.4); }
  50% { box-shadow: 0 0 20px 4px rgba(213,253,81,0.2); }
}

.logo-text {
  font-family: 'Syne', sans-serif;
  font-weight: 800;
  font-size: 16px;
  letter-spacing: -0.5px;
}

.logo-text span { color: var(--neon); }

.header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.chain-badge {
  font-size: 11px;
  color: var(--text-muted);
  border: 1px solid var(--border);
  padding: 4px 10px;
  border-radius: 4px;
  letter-spacing: 1px;
  text-transform: uppercase;
}

.btn-connect {
  background: var(--neon);
  color: var(--black);
  border: none;
  padding: 8px 18px;
  border-radius: 6px;
  font-family: 'DM Mono', monospace;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  letter-spacing: 0.5px;
  transition: all 0.2s;
}
.btn-connect:hover { background: #c5ed41; transform: translateY(-1px); }

.btn-faucet {
  background: transparent;
  color: var(--neon);
  border: 1px solid rgba(213,253,81,0.35);
  padding: 8px 16px;
  border-radius: 6px;
  font-family: 'DM Mono', monospace;
  font-size: 12px;
  cursor: pointer;
  letter-spacing: 0.5px;
  text-decoration: none;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 5px;
}
.btn-faucet:hover { background: var(--neon-dim); border-color: var(--neon); }
.btn-connect.connected {
  background: var(--surface2);
  color: var(--neon);
  border: 1px solid var(--border);
  cursor: default;
}
.btn-connect.connected:hover { transform: none; background: var(--surface2); }

/* Chart */
#tv_chart {
  width: 100%;
  border-bottom: 1px solid var(--border);
}

/* Main layout */
.main {
  max-width: 520px;
  margin: 0 auto;
  padding: 28px 20px 60px;
}

/* Stats panel */
.stats-panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 16px;
  animation: fadeUp 0.4s ease both;
}

@keyframes fadeUp {
  from { opacity:0; transform:translateY(12px); }
  to   { opacity:1; transform:translateY(0); }
}

.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 16px;
}

.stat-item {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px 14px;
}

.stat-label {
  font-size: 10px;
  color: var(--text-muted);
  letter-spacing: 1.5px;
  text-transform: uppercase;
  margin-bottom: 4px;
}

.stat-value {
  font-size: 16px;
  font-weight: 500;
  color: var(--text);
}

.stat-value.neon { color: var(--neon); }
.stat-value.up   { color: var(--up); }
.stat-value.down { color: var(--down); }

/* Round status row */
.round-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  margin-bottom: 16px;
}

.round-label { font-size: 11px; color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase; }
.round-num { font-size: 14px; color: var(--text); }

.status-pill {
  font-size: 10px;
  font-weight: 500;
  padding: 3px 10px;
  border-radius: 20px;
  letter-spacing: 1px;
  text-transform: uppercase;
}
.status-active  { background: rgba(74,222,128,0.15); color: var(--up); border: 1px solid rgba(74,222,128,0.3); }
.status-ended   { background: rgba(248,113,113,0.12); color: var(--down); border: 1px solid rgba(248,113,113,0.3); }
.status-waiting { background: var(--neon-dim); color: var(--neon); border: 1px solid rgba(213,253,81,0.3); }

/* Timer */
.timer-block {
  text-align: center;
  padding: 16px;
  background: var(--neon-dim2);
  border: 1px solid rgba(213,253,81,0.15);
  border-radius: 8px;
  margin-bottom: 16px;
}

.timer-label { font-size: 10px; color: var(--text-muted); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 4px; }
.timer-value { font-family: 'Syne', sans-serif; font-size: 36px; font-weight: 800; color: var(--neon); letter-spacing: -1px; }
.timer-value.ended { color: var(--down); font-size: 14px; font-weight: 500; font-family: 'DM Mono', monospace; letter-spacing: 0; }

/* Pool bar */
.pool-bar-wrap { margin-bottom: 16px; }
.pool-bar-labels {
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  margin-bottom: 6px;
}
.pool-bar-labels .up-label { color: var(--up); }
.pool-bar-labels .down-label { color: var(--down); }
.pool-bar-track {
  height: 6px;
  background: var(--down-dim);
  border-radius: 3px;
  overflow: hidden;
  border: 1px solid var(--border);
}
.pool-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--up), #22c55e);
  border-radius: 3px;
  transition: width 0.6s ease;
}

/* Divider */
.divider { border: none; border-top: 1px solid var(--border); margin: 18px 0; }

/* Bet panel */
.bet-panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 16px;
  animation: fadeUp 0.4s ease 0.1s both;
}

.bet-panel-title {
  font-size: 10px;
  color: var(--text-muted);
  letter-spacing: 2px;
  text-transform: uppercase;
  margin-bottom: 16px;
}

.amount-input-wrap {
  position: relative;
  margin-bottom: 16px;
}

.amount-input {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 14px 50px 14px 16px;
  font-family: 'DM Mono', monospace;
  font-size: 20px;
  color: var(--text);
  outline: none;
  transition: border-color 0.2s;
}
.amount-input:focus { border-color: var(--neon); }
.amount-input::placeholder { color: var(--text-dim); }

.amount-suffix {
  position: absolute;
  right: 14px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 12px;
  color: var(--text-muted);
}

/* Duration buttons */
.dur-label {
  font-size: 10px;
  color: var(--text-muted);
  letter-spacing: 2px;
  text-transform: uppercase;
  margin-bottom: 8px;
}

.dur-group {
  display: flex;
  gap: 6px;
  margin-bottom: 18px;
}

.dur-btn {
  flex: 1;
  padding: 8px 4px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text-muted);
  font-family: 'DM Mono', monospace;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.15s;
  text-align: center;
}
.dur-btn:hover { border-color: var(--neon); color: var(--text); }
.dur-btn.active { background: var(--neon-dim); border-color: var(--neon); color: var(--neon); }

/* Bet buttons */
.bet-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }

.btn-up, .btn-down {
  padding: 16px;
  border: none;
  border-radius: 8px;
  font-family: 'Syne', sans-serif;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn-up {
  background: var(--up-dim);
  color: var(--up);
  border: 1px solid rgba(74,222,128,0.3);
}
.btn-up:hover:not(:disabled) {
  background: var(--up);
  color: var(--black);
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(74,222,128,0.25);
}
.btn-up:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }

.btn-down {
  background: var(--down-dim);
  color: var(--down);
  border: 1px solid rgba(248,113,113,0.3);
}
.btn-down:hover:not(:disabled) {
  background: var(--down);
  color: var(--black);
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(248,113,113,0.25);
}
.btn-down:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }

/* Hint */
#betHint {
  text-align: center;
  font-size: 11px;
  min-height: 18px;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
}

/* Claim button */
.btn-claim {
  width: 100%;
  padding: 13px;
  background: var(--neon-dim);
  border: 1px solid rgba(213,253,81,0.3);
  border-radius: 8px;
  color: var(--neon);
  font-family: 'DM Mono', monospace;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
  letter-spacing: 0.5px;
}
.btn-claim:hover:not(:disabled) {
  background: var(--neon);
  color: var(--black);
  font-weight: 600;
}
.btn-claim:disabled { opacity: 0.3; cursor: not-allowed; }

/* Active bets */

/* Owner panel */
.owner-panel {
  background: var(--surface);
  border: 1px solid rgba(213,253,81,0.2);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 16px;
  animation: fadeUp 0.4s ease 0.3s both;
}
.owner-panel-title {
  font-size: 10px;
  color: var(--neon);
  letter-spacing: 2px;
  text-transform: uppercase;
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.owner-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
}
.owner-input {
  flex: 1;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 9px 12px;
  font-family: 'DM Mono', monospace;
  font-size: 13px;
  color: var(--text);
  outline: none;
}
.owner-input:focus { border-color: var(--neon); }
.btn-owner {
  padding: 9px 14px;
  border: none;
  border-radius: 6px;
  font-family: 'DM Mono', monospace;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}
.btn-deposit  { background: var(--neon-dim); color: var(--neon); border: 1px solid rgba(213,253,81,0.3); }
.btn-deposit:hover  { background: var(--neon); color: var(--black); }
.btn-withdraw { background: var(--up-dim); color: var(--up); border: 1px solid rgba(74,222,128,0.3); }
.btn-withdraw:hover { background: var(--up); color: var(--black); }
.btn-withdraw-all { background: var(--down-dim); color: var(--down); border: 1px solid rgba(248,113,113,0.3); }
.btn-withdraw-all:hover { background: var(--down); color: var(--black); }
.owner-stats {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 8px;
  margin-bottom: 14px;
}
.owner-stat {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 8px 10px;
  text-align: center;
}
.owner-stat-label { font-size: 9px; color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 3px; }
.owner-stat-val   { font-size: 13px; color: var(--neon); }

.bets-section {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px 20px;
  animation: fadeUp 0.4s ease 0.2s both;
}

.bets-title {
  font-size: 10px;
  color: var(--text-muted);
  letter-spacing: 2px;
  text-transform: uppercase;
  margin-bottom: 12px;
}

.bet-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  margin-bottom: 6px;
  transition: border-color 0.2s;
}
.bet-item:hover { border-color: var(--border-light); }

.bet-dir-badge {
  font-size: 10px;
  font-weight: 600;
  padding: 3px 8px;
  border-radius: 4px;
  letter-spacing: 1px;
  min-width: 44px;
  text-align: center;
}
.bet-dir-badge.up   { background: var(--up-dim); color: var(--up); border: 1px solid rgba(74,222,128,0.2); }
.bet-dir-badge.down { background: var(--down-dim); color: var(--down); border: 1px solid rgba(248,113,113,0.2); }

.bet-info { flex: 1; }
.bet-amount { font-size: 13px; color: var(--text); }
.bet-meta { font-size: 10px; color: var(--text-muted); margin-top: 2px; letter-spacing: 0.5px; }

.bet-timer { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; color: var(--neon); min-width: 52px; text-align: right; }
.bet-timer.expired { font-family: 'DM Mono', monospace; font-size: 10px; font-weight: 400; color: var(--down); letter-spacing: 1px; }

/* Settled result banner */
.result-banner {
  display: none;
  padding: 14px 18px;
  border-radius: 8px;
  margin-bottom: 16px;
  text-align: center;
  font-family: 'Syne', sans-serif;
  font-weight: 700;
  font-size: 15px;
  letter-spacing: 0.5px;
}
.result-banner.up-won { background: var(--up-dim); border: 1px solid rgba(74,222,128,0.3); color: var(--up); }
.result-banner.down-won { background: var(--down-dim); border: 1px solid rgba(248,113,113,0.3); color: var(--down); }
.result-banner.show { display: block; }

</style>
</head>
<body>
<div class="page">

  <!-- Header -->
  <header class="header">
    <div class="logo">
      <div class="logo-icon"></div>
      <div class="logo-text">BLOCK<span>ORACLE</span></div>
    </div>
    <div class="header-right">
      <a href="https://faucet.testnet.chain.robinhood.com/?error=undefined&address=0x6d4D522f22681b76483BF327ff7Bb6748a68Da5c&step=auth" target="_blank" class="btn-faucet">ðŸ’§ Faucet</a>
      <div class="chain-badge">Robinhood Chain Â· 46630</div>
      <button class="btn-connect" id="btnConnect" onclick="connect()">Connect Wallet</button>
    </div>
  </header>

  <!-- Chart -->
  <div id="tv_chart"></div>

  <!-- Main -->
  <div class="main">

    <!-- Stats -->
    <div class="stats-panel">
      <!-- Round row -->
      <div class="round-row">
        <div>
          <div class="round-label">Round</div>
          <div class="round-num" id="round">â€”</div>
        </div>
        <div style="text-align:center;">
          <div class="round-label">Lock Price</div>
          <div class="round-num" id="lockPrice">â€”</div>
        </div>
        <span id="roundStatus" class="status-pill status-waiting">â€”</span>
      </div>

      <!-- Pool bar -->
      <div class="pool-bar-wrap">
        <div class="pool-bar-labels">
          <span class="up-label">â–² UP &nbsp;<span id="upPool">0.0000 ETH</span></span>
          <span style="color:var(--text-muted)" id="probUp">0%</span>
          <span class="down-label"><span id="downPool">0.0000 ETH</span>&nbsp; DOWN â–¼</span>
        </div>
        <div class="pool-bar-track">
          <div class="pool-bar-fill" id="poolBar" style="width:50%"></div>
        </div>
      </div>

      <!-- Stats grid -->
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-label">Wallet</div>
          <div class="stat-value" id="wallet" style="font-size:13px;">Not connected</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Round ends in</div>
          <div class="stat-value neon" id="timeLeftSmall">â€”</div>
        </div>
      </div>

      <!-- Result banner -->
      <div class="result-banner" id="resultBanner"></div>
    </div>

    <!-- Bet panel -->
    <div class="bet-panel">
      <div class="bet-panel-title">Place your bet</div>

      <div class="amount-input-wrap">
        <input class="amount-input" id="amount" type="number" placeholder="0.0001" step="0.0001" min="0.0001"/>
        <span class="amount-suffix">ETH</span>
      </div>

      <div class="dur-label">Duration</div>
      <div class="dur-group">
        <button class="dur-btn active" onclick="selectDuration(1, this)">1m</button>
        <button class="dur-btn" onclick="selectDuration(2, this)">2m</button>
        <button class="dur-btn" onclick="selectDuration(3, this)">3m</button>
        <button class="dur-btn" onclick="selectDuration(4, this)">4m</button>
        <button class="dur-btn" onclick="selectDuration(5, this)">5m</button>
      </div>

      <div class="bet-buttons">
        <button class="btn-up" id="btnUp" onclick="betUp()" disabled>â–² &nbsp;UP</button>
        <button class="btn-down" id="btnDown" onclick="betDown()" disabled>â–¼ &nbsp;DOWN</button>
      </div>

      <div id="betHint"></div>

      <button class="btn-claim" id="btnClaim" onclick="claim()" disabled>â˜… &nbsp;Claim Winnings</button>
    </div>

    <!-- Active bets -->

    <!-- Owner panel (hidden, shown only for owner) -->
    <div class="owner-panel" id="ownerPanel" style="display:none;">
      <div class="owner-panel-title">â¬¡ &nbsp;Owner Controls</div>

      <!-- Balance info -->
      <div class="owner-stats">
        <div class="owner-stat">
          <div class="owner-stat-label">Contract</div>
          <div class="owner-stat-val" id="ownerBalContract">â€”</div>
        </div>
        <div class="owner-stat">
          <div class="owner-stat-label">My Profit</div>
          <div class="owner-stat-val" id="ownerBalProfit">â€”</div>
        </div>
        <div class="owner-stat">
          <div class="owner-stat-label">Liquidity</div>
          <div class="owner-stat-val" id="ownerBalLiquidity">â€”</div>
        </div>
      </div>

      <!-- Deposit liquidity -->
      <div class="owner-row">
        <input class="owner-input" id="depositAmount" type="number" placeholder="ETH amount" step="0.001" min="0.001"/>
        <button class="btn-owner btn-deposit" onclick="ownerDeposit()">â¬† Deposit</button>
      </div>

      <!-- Withdraw profit -->
      <div class="owner-row">
        <input class="owner-input" id="withdrawAmount" type="number" placeholder="ETH (0 = all profit)" step="0.001" min="0"/>
        <button class="btn-owner btn-withdraw" onclick="ownerWithdraw()">â¬‡ Withdraw Profit</button>
        <button class="btn-owner btn-withdraw-all" onclick="ownerWithdrawAll()">All</button>
      </div>
    </div>

    <div class="bets-section" id="betsSection" style="display:none;">
      <div class="bets-title">My Active Bets</div>
      <div id="betsList"></div>
    </div>

  </div>
</div>

<script>

const CONTRACT_ADDRESS = "0xE1D77C412785eD34B991f871fFc51f6458deB997";
const CHAIN_ID = 46630;

const abi = [
  "function betUp() payable",
  "function betDown() payable",
  "function claim(uint256,address)",
  "function startRound(uint256,uint256)",
  "function settleRound(uint256)",
  "function currentRound() view returns(uint256)",
  "function rounds(uint256) view returns(uint256,uint256,uint256,uint256,uint256,uint256,bool,bool)",
  "function pools(uint256,address) view returns(uint256,uint256)",
  "function owner() view returns(address)",
  "function depositLiquidity() payable",
  "function withdrawProfit(uint256)",
  "function withdrawLiquidity(uint256)",
  "function balanceInfo() view returns(uint256,uint256,uint256)",
  "function previewPayout(uint256,address) view returns(uint256)",
  "function ownerProfit() view returns(uint256)",
  "function liquidityPool() view returns(uint256)"
];

let provider, signer, contract, user, contractOwner;
let roundTimerInterval = null;
let selectedDuration = 1;
let activeBets = [];
let betsRenderInterval = null;
let isRoundActive = false;
let alreadyBetThisRound = false;

function selectDuration(min, btn) {
  selectedDuration = min;
  document.querySelectorAll('.dur-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function updateBetButtons() {
  const connected = !!user && !!contract;
  const canBet = connected && !alreadyBetThisRound;
  document.getElementById("btnUp").disabled = !canBet;
  document.getElementById("btnDown").disabled = !canBet;
  const hint = document.getElementById("betHint");
  if (connected && alreadyBetThisRound) {
    hint.innerText = "âœ“ Already bet this round";
    hint.style.color = "var(--up)";
  } else {
    hint.innerText = "";
  }
}

function addActiveBet(direction, amount, durationMin, roundId) {
  const endTime = Math.floor(Date.now() / 1000) + durationMin * 60;
  activeBets.push({ direction, amount, endTime, roundId: roundId.toString(), durationMin });
  renderBets();
  if (!betsRenderInterval) betsRenderInterval = setInterval(renderBets, 1000);
}

function renderBets() {
  const list = document.getElementById('betsList');
  const section = document.getElementById('betsSection');
  if (activeBets.length === 0) { section.style.display = 'none'; return; }
  section.style.display = 'block';
  const now = Math.floor(Date.now() / 1000);
  list.innerHTML = activeBets.map(bet => {
    const left = bet.endTime - now;
    const timerHtml = left > 0
      ? `<div class="bet-timer">${formatTime(left)}</div>`
      : `<div class="bet-timer expired">AWAITING</div>`;
    const dirClass = bet.direction === 'UP' ? 'up' : 'down';
    return `<div class="bet-item">
      <span class="bet-dir-badge ${dirClass}">${bet.direction}</span>
      <div class="bet-info">
        <div class="bet-amount">${parseFloat(bet.amount).toFixed(4)} ETH</div>
        <div class="bet-meta">Round #${bet.roundId} Â· ${bet.durationMin}m</div>
      </div>
      ${timerHtml}
    </div>`;
  }).join('');
}

function formatTime(seconds) {
  const m = Math.floor(seconds / 60);
  const s = seconds % 60;
  return m > 0 ? `${m}:${s.toString().padStart(2,'0')}` : `${s}s`;
}

async function connect() {
  if (!window.ethereum) { alert("MetaMask not found!"); return; }
  try {
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    const network = await provider.getNetwork();
    if (network.chainId !== CHAIN_ID) {
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: '0x' + CHAIN_ID.toString(16) }]
        });
        provider = new ethers.providers.Web3Provider(window.ethereum);
      } catch(e) {
        alert("Switch to Robinhood Chain Testnet (ChainID: 46630)");
        return;
      }
    }
    signer = provider.getSigner();
    user = await signer.getAddress();
    contract = new ethers.Contract(CONTRACT_ADDRESS, abi, signer);
    contractOwner = await contract.owner();

    document.getElementById("wallet").innerText = user.slice(0,6) + "..." + user.slice(-4);
    const btn = document.getElementById("btnConnect");
    btn.innerText = user.slice(0,6) + "..." + user.slice(-4);
    btn.classList.add("connected");
    btn.onclick = null;

    document.getElementById("btnClaim").disabled = false;
    updateBetButtons();
    await loadData();
    setInterval(loadData, 10000);
  } catch(e) {
    alert("Connection error: " + e.message);
  }
}

async function loadData() {
  if (!contract) return;
  try {
    const roundId = await contract.currentRound();
    document.getElementById("round").innerText = "#" + roundId.toString();

    const banner = document.getElementById("resultBanner");

    if (roundId.toNumber() === 0) {
      isRoundActive = false;
      alreadyBetThisRound = false;
      updateBetButtons();
      setStatus("No rounds yet", "waiting");
      document.getElementById("timeLeftSmall").innerText = "â€”";
      document.getElementById("lockPrice").innerText = "â€”";
      banner.className = "result-banner";
      return;
    }

    const pool = await contract.pools(roundId, ethers.constants.AddressZero);
    const up = parseFloat(ethers.utils.formatEther(pool[0]));
    const down = parseFloat(ethers.utils.formatEther(pool[1]));
    document.getElementById("upPool").innerText = up.toFixed(4) + " ETH";
    document.getElementById("downPool").innerText = down.toFixed(4) + " ETH";
    const total = up + down;
    const prob = total > 0 ? (up / total * 100).toFixed(1) : 50;
    document.getElementById("probUp").innerText = prob + "%";
    document.getElementById("poolBar").style.width = prob + "%";

    const round = await contract.rounds(roundId);
    const endTime = round[1].toNumber();
    const lockPriceRaw = round[2].toNumber();
    const settled = round[6];

    document.getElementById("lockPrice").innerText = lockPriceRaw > 0 ? "$" + lockPriceRaw.toLocaleString() : "â€”";

    const now = Math.floor(Date.now() / 1000);

    if (settled) {
      isRoundActive = false;
      alreadyBetThisRound = false;
      const upWon = round[7];
      const closePrice = round[3].toNumber();
      setStatus("Settled", "waiting");
      document.getElementById("timeLeftSmall").innerText = "â€”";
      if (roundTimerInterval) { clearInterval(roundTimerInterval); roundTimerInterval = null; }
      banner.className = "result-banner show " + (upWon ? "up-won" : "down-won");
      banner.innerHTML = upWon
        ? `â–² UP WON &nbsp;Â·&nbsp; Close $${closePrice.toLocaleString()}`
        : `â–¼ DOWN WON &nbsp;Â·&nbsp; Close $${closePrice.toLocaleString()}`;
    } else if (now >= endTime) {
      isRoundActive = false;
      alreadyBetThisRound = false;
      setStatus("Settling...", "ended");
      document.getElementById("timeLeftSmall").innerText = "â€”";
      if (roundTimerInterval) { clearInterval(roundTimerInterval); roundTimerInterval = null; }
      banner.className = "result-banner";
      await autoSettle();
    } else {
      isRoundActive = true;
      setStatus("Active", "active");
      startRoundTimer(endTime);
      banner.className = "result-banner";
      if (user) {
        const userBet = await contract.pools(roundId, user);
        alreadyBetThisRound = userBet[0].gt(0) || userBet[1].gt(0);
      }
    }

    updateBetButtons();
    await loadOwnerStats();
  } catch(e) {
    console.error("loadData error:", e);
  }
}

function setStatus(text, type) {
  const el = document.getElementById("roundStatus");
  el.innerText = text;
  el.className = "status-pill status-" + type;
}

function startRoundTimer(endTime) {
  if (roundTimerInterval) clearInterval(roundTimerInterval);
  roundTimerInterval = setInterval(async () => {
    const now = Math.floor(Date.now() / 1000);
    const left = endTime - now;
    if (left > 0) {
      document.getElementById("timeLeftSmall").innerText = formatTime(left);
    } else {
      isRoundActive = false;
      alreadyBetThisRound = false;
      updateBetButtons();
      setStatus("Settling...", "ended");
      document.getElementById("timeLeftSmall").innerText = "â€”";
      clearInterval(roundTimerInterval);
      roundTimerInterval = null;
      await autoSettle();
    }
  }, 1000);
}

async function autoSettle() {
  if (!contract || !user || !contractOwner) return;
  if (user.toLowerCase() !== contractOwner.toLowerCase()) {
    setTimeout(loadData, 5000);
    return;
  }
  try {
    let closePrice = 0;
    try {
      const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd");
      const data = await res.json();
      closePrice = Math.round(data.bitcoin.usd);
    } catch(e) {
      setTimeout(autoSettle, 5000);
      return;
    }
    const tx = await contract.settleRound(closePrice);
    await tx.wait();
    await loadData();
  } catch(e) {
    console.error("Auto-settle failed:", e.reason || e.message);
    setTimeout(autoSettle, 10000);
  }
}

async function autoStartRound() {
  try {
    const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd");
    const data = await res.json();
    const lockPrice = Math.round(data.bitcoin.usd);
    const tx = await contract.startRound(selectedDuration, lockPrice);
    await tx.wait();
    await loadData();
  } catch(e) {
    alert("Could not start round: " + (e.reason || e.message));
  }
}

async function betUp() {
  if (!checkConnected()) return;
  const amount = document.getElementById("amount").value;
  if (!amount || parseFloat(amount) <= 0) { alert("Enter a valid amount"); return; }
  try {
    document.getElementById("btnUp").disabled = true;
    document.getElementById("btnDown").disabled = true;
    if (!isRoundActive) {
      await autoStartRound();
      if (!isRoundActive) return;
    }
    const roundId = await contract.currentRound();
    const tx = await contract.betUp({ value: ethers.utils.parseEther(amount) });
    await tx.wait();
    addActiveBet('UP', amount, selectedDuration, roundId);
    await loadData();
  } catch(e) {
    alert("Bet UP failed: " + (e.reason || e.message));
  } finally {
    updateBetButtons();
  }
}

async function betDown() {
  if (!checkConnected()) return;
  const amount = document.getElementById("amount").value;
  if (!amount || parseFloat(amount) <= 0) { alert("Enter a valid amount"); return; }
  try {
    document.getElementById("btnDown").disabled = true;
    document.getElementById("btnUp").disabled = true;
    if (!isRoundActive) {
      await autoStartRound();
      if (!isRoundActive) return;
    }
    const roundId = await contract.currentRound();
    const tx = await contract.betDown({ value: ethers.utils.parseEther(amount) });
    await tx.wait();
    addActiveBet('DOWN', amount, selectedDuration, roundId);
    await loadData();
  } catch(e) {
    alert("Bet DOWN failed: " + (e.reason || e.message));
  } finally {
    updateBetButtons();
  }
}

async function claim() {
  if (!checkConnected()) return;
  try {
    const roundId = await contract.currentRound();
    const prevRound = roundId.sub(1);
    const tx = await contract.claim(prevRound, user);
    await tx.wait();
    activeBets = activeBets.filter(b => b.endTime > Math.floor(Date.now() / 1000));
    renderBets();
    alert("Claimed!");
  } catch(e) {
    alert("Claim failed: " + (e.reason || e.message));
  }
}


// â”€â”€â”€ Owner panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadOwnerStats() {
  if (!contract || !user || user.toLowerCase() !== contractOwner.toLowerCase()) return;
  try {
    const info = await contract.balanceInfo();
    const fmt = (v) => parseFloat(ethers.utils.formatEther(v)).toFixed(4) + " ETH";
    document.getElementById("ownerBalContract").innerText  = fmt(info[0]);
    document.getElementById("ownerBalProfit").innerText    = fmt(info[1]);
    document.getElementById("ownerBalLiquidity").innerText = fmt(info[2]);
  } catch(e) { console.error("loadOwnerStats:", e); }
}

async function ownerDeposit() {
  const amount = document.getElementById("depositAmount").value;
  if (!amount || parseFloat(amount) <= 0) { alert("Enter ETH amount to deposit"); return; }
  try {
    const tx = await contract.depositLiquidity({ value: ethers.utils.parseEther(amount) });
    await tx.wait();
    document.getElementById("depositAmount").value = "";
    await loadOwnerStats();
    alert("Deposited " + amount + " ETH as liquidity âœ“");
  } catch(e) { alert("Deposit failed: " + (e.reason || e.message)); }
}

async function ownerWithdraw() {
  const input = document.getElementById("withdrawAmount").value;
  const amount = (!input || parseFloat(input) === 0) ? 0 : ethers.utils.parseEther(input);
  try {
    const tx = await contract.withdrawProfit(amount);
    await tx.wait();
    document.getElementById("withdrawAmount").value = "";
    await loadOwnerStats();
    alert("Profit withdrawn âœ“");
  } catch(e) { alert("Withdraw failed: " + (e.reason || e.message)); }
}

async function ownerWithdrawAll() {
  try {
    const tx = await contract.withdrawProfit(0); // 0 = withdraw all
    await tx.wait();
    await loadOwnerStats();
    alert("All profit withdrawn âœ“");
  } catch(e) { alert("Withdraw failed: " + (e.reason || e.message)); }
}

function checkConnected() {
  if (!user || !contract) { alert("Please connect your wallet first"); return false; }
  return true;
}

new TradingView.widget({
  "container_id": "tv_chart",
  "symbol": "BINANCE:BTCUSDT",
  "interval": "1",
  "theme": "dark",
  "width": "100%",
  "height": "380"
});

</script>
</body>
</html>
