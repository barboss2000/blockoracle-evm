<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>BTC Prediction Market</title>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://s3.tradingview.com/tv.js"></script>

<style>
body { background:#0b1220; color:white; font-family:Arial; text-align:center; }
.card { background:#1b2438; padding:25px; border-radius:15px; width:460px; margin:auto; }
button { padding:10px; margin:5px; border-radius:8px; border:none; cursor:pointer; font-weight:bold;}
.green{background:#1db954;color:white;}
.red{background:#e84142;color:white;}
.blue{background:#5865f2;color:white;}
.yellow{background:#f1c40f;}
select,input{padding:6px;border-radius:6px;border:none;margin:5px;}
.stat{margin:6px;}
</style>
</head>

<body>

<h2>BTC Prediction Market</h2>

<div id="tv_chart"></div>

<br>

<div class="card">

<div class="stat"><b>Wallet:</b> <span id="wallet">Not connected</span></div>
<div class="stat"><b>Round:</b> <span id="round">-</span></div>
<div class="stat"><b>UP Pool:</b> <span id="upPool">0</span></div>
<div class="stat"><b>DOWN Pool:</b> <span id="downPool">0</span></div>
<div class="stat"><b>UP Probability:</b> <span id="probUp">0%</span></div>
<div class="stat"><b>Time left:</b> <span id="timeLeft">-</span></div>

<select id="tokenSelect">
<option value="ETH">ETH</option>
</select>

<br>

<input id="amount" type="number" placeholder="Amount" step="0.001"/>

<br>

<button class="green" onclick="betUp()">Bet UP</button>
<button class="red" onclick="betDown()">Bet DOWN</button>

<br>

<button class="yellow" onclick="claim()">Claim</button>
<button class="blue" onclick="connect()">Connect</button>

</div>

<script>

// ================= CONTRACT =================

const contractAddress = "0x788c77B4F510C477517C6635d657625D1aB05676";

const abi = [
  "function betUp() payable",
  "function betDown() payable",
  "function claim(uint256,address)",
  "function settle(bool)",
  "function currentRound() view returns(uint256)",
  "function rounds(uint256) view returns(uint256,uint256,bool,bool)",
  "function pools(uint256,address) view returns(uint256,uint256)"
];

let provider, signer, contract, user;

// ================= CONNECT =================

async function connect(){
  if(!window.ethereum){
    alert("Install MetaMask");
    return;
  }

  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts",[]);
  signer = provider.getSigner();
  user = await signer.getAddress();

  contract = new ethers.Contract(contractAddress, abi, signer);

  document.getElementById("wallet").innerText =
    user.slice(0,6)+"..."+user.slice(-4);

  loadData();
}

// ================= LOAD DATA =================

async function loadData(){
  const roundId = await contract.currentRound();
  document.getElementById("round").innerText = roundId;

  const pool = await contract.pools(roundId, ethers.constants.AddressZero);

  const up = parseFloat(ethers.utils.formatEther(pool[0]));
  const down = parseFloat(ethers.utils.formatEther(pool[1]));

  document.getElementById("upPool").innerText = up.toFixed(4)+" ETH";
  document.getElementById("downPool").innerText = down.toFixed(4)+" ETH";

  const total = up + down;
  const prob = total > 0 ? (up/total*100).toFixed(1) : 0;
  document.getElementById("probUp").innerText = prob+"%";

  const round = await contract.rounds(roundId);
  startTimer(round[1]);
}

// ================= TIMER =================

function startTimer(endTime){
  setInterval(()=>{
    const now = Math.floor(Date.now()/1000);
    const left = endTime - now;
    document.getElementById("timeLeft").innerText =
      left > 0 ? left+" sec" : "Ended";
  },1000);
}

// ================= BET =================

async function betUp(){
  const amount = document.getElementById("amount").value;
  if(!amount) return alert("Enter amount");

  const tx = await contract.betUp({
    value: ethers.utils.parseEther(amount)
  });

  await tx.wait();
  loadData();
}

async function betDown(){
  const amount = document.getElementById("amount").value;
  if(!amount) return alert("Enter amount");

  const tx = await contract.betDown({
    value: ethers.utils.parseEther(amount)
  });

  await tx.wait();
  loadData();
}

// ================= CLAIM =================

async function claim(){
  const roundId = await contract.currentRound();
  const tx = await contract.claim(roundId-1, ethers.constants.AddressZero);
  await tx.wait();
  alert("Claimed!");
}

// ================= BTC CHART =================

new TradingView.widget({
  "container_id": "tv_chart",
  "symbol": "BINANCE:BTCUSDT",
  "interval": "5",
  "timezone": "Etc/UTC",
  "theme": "dark",
  "style": "1",
  "locale": "en",
  "width": "100%",
  "height": "400"
});

</script>

</body>
</html>
